---
title: 第一讲——网络编程初识
id: 1
date: 2019-8-14 10:00:00
tags: socket和并发编程
comment: true
---

### 学习大纲

- C/S 和B/S架构
- 物理层
- 数据链路层
- 传输层

超链：https://www.cnblogs.com/wlx97e6/p/9301998.html

<!-----more----->

### C/S 和B/S架构

C:client端

B:browse浏览器

S：server端

对比C/S和B/S架构：

**C/S架构：**基于客户端与服务器之间的通信

优点：个性化设置，响应速度快

缺点：开发成本高，维护成本高，占用空间，用户固定

**B/S架构：**

基于浏览器与服务器之间的通信

优点：开发成本低，维护成本低，占用空间相对低，用户不固定

缺点：功能单一，没有个性化设置，响应速度相对较慢

**osi七层协议（也称作5层）**

应用层（表示层、会话层）

传输层

网络层

数据链路层

物理层

### 物理层

- 网线、光纤、无线电波等介质，发送的是比特流。

### 数据链路层

- 数据链路层的由来：单纯的电信号0和1是没有任何意义的，必须规定电信号电信号多少位一组，这个对比特流进行分组就是数据链路层的功能。
- 以太网协议：一组电信号构成了一个数据报，也叫做一帧。
- 一帧的构成：报头head+data数据
  - |  head   |  data  |
  - head:
    - 源地址：6个字节
    - 目的地址：6个字节
    - 数据类型：6个字节
  - data:
    - 最短46字节
    - 最长1500字节
    - 数据包的具体内容
  - head长度+data长度 = 最短64字节，最长1518字节，超过最大限制就分片发送。
- mac地址：
  - 全世界唯一的mac地址
  - 长度48位的2进制数据，一般FF:FF:FF:FF:FF:FF

### 网络层

- 网络层的由来：有了以太网一些（ethernet）、mac地址、广播的发送方式，世界上的计算机就可以彼此通信了，问题是世界范围内的互联网是由一个个彼此隔离的小的局域网组成的，那么如果所有的通信都采用以太网的广播方式，那么一台机器发送的包全世界都会收到，这就不仅仅是效率低的问题了，这会是一种灾难，因此有了网络层的由来。
- 网络层的功能：引入一套新的地址用来区分不同的广播域/z子网,这就是网络地址。
- IP协议：
  - 规定网络地址的协议叫做ip协议，它定义的地址称之为ip地址，广泛采用的v4版本，由32位的2进制数据组成。
  - ip地址的组成
    - 网络部分：标识子网
    - 主机部分：标识主机
    - 注意：单纯的ip地址只是标识了ip地址的种类（ABCDE)，从网络部分或主机部分都无法辨识一个ip所处的子网
      - 例子：172.16.1.10和172.16.1.11并不能确定二者处于同一个子网。
    - 子网掩码：
      - 所谓的子网掩码，就是表示网络特征的一个参数，它的形式等同于一个IP地址，它的网络位全部是1，主机部分全部是0.知道子网掩码，我们就能判断任意的两个ip地址是否处于同一个子网中。方法就是将两个IP地址与子网掩码进行AND运算，结果相同就表示他们处于同一个子网中，否则不是。
  - 总结：IP协议的主要作用有两个
    - 为每一台计算机分配IP地址
    - 确定哪些地址在同一个子网中
- ip数据包
  - ip数据包也分为head和data部分，无需为ip包定义单独的栏位，直接放入以太网包的data部分。
  - head：长度20—60字节
  - data：最长65535字节
  - 以太数据包的数据部分最长只用1500字节。因此，如果数据包超过了1500字节，他就需要分割成几个以太网数据包，这就是切片。
- ARP协议
  - ARP协议的由来：计算机通信基本靠吼，也就是广播的方式，所有上层的包到最后都要封装上以太网头，然后通过以太协议发送，计算机在发送包时，获取自身mac很容易，但是如何获取目标主机的mac，就需要arp协议。
  - ARP协议的功能：广播的方式发送数据包，获取目标主机的ip地址获取主机的mac地址。
  - 协议工作的方式
    - 每台主机的ip是已知的，首先通过ip地址和子网掩码分出自己所处的子网。
    - 同一子网，直接找到目标主机的mac；不同子网找到目标网关的mac，最终找到目标ip的mac。
    - 这个包会以广播的方式在发送端所处的子网内传输，所有的主机接受后拆开包，发现目标ip为自己的，就响应返回自己的mac。

### 传输层

- 传输层的由来：网络层的ip帮助我们区分子网，以太网层的mac帮我们找到主机，然后大家使用的都是应用程序，那么我们通过ip和mac找到一台特定的主机，如何表示主机上的应用程序，这就是端口，端口就是应用程序与网卡关联的编号。

- 端口号的范围：0-65535,0-1023被系统占用（因为这些都是一些固定的端口号），推荐使用8080之后的端口。

  固定端口号对应的服务：https://www.iana.org/assignments/service-names-port-numbers/service-names-port-numbers.xhtml?&page=2

- 端口协议：TCP协议，UDP协议

- TCP协议：
  - 可靠传输，TCP数据包没有长度限制，理论上可以无限长，但是为了保证网络的效率，通常TCP数据包的长度不会超过IP数据包的长度（1500字节）,以确保单个TCP数据包不必分割。
  
  - 报头
    - 以太网头+IP头+tcp头+数据
    - ![img](http://9017499461.linshutu.top/2.JPG)
    
  - TCP的3次握手和4次挥手
    
    外链：https://blog.csdn.net/qq_38950316/article/details/81087809
    
    - 首先了解几个字段的含义：
      - 序号：Seq序号，占32位，用来标标志从TCP源端向目的端发送的字节流，发起方发送数据时对此进行标记。
      - 确认序号：Ack，占32位，只有Ack标志为1时，确认字段才有效，Ack=Seq+1
      - 标志位：共6个，URG、ACK、PSH、RST、SYN、FIN
        - URG：紧急指针有效
        - ACK：确认序号有效（和上面的Ack不一样）
        - PSH：接收方应该尽快把这个报文给应用层
        - RST：重置连接
        - SYN：发起一个新连接
        - FIN：释放一个连接
    - 3次握手
      - 第一次：客户端向服务器端发送一个syn=1，seq=x（x随机产生）报文给服务器，进入syn_send状态（等待server确认）。
      - 第二次：服务端收到SYN=1报文，知道客户端请求建立连接，将SYN和ACK都置1，ack=x+1（确认号=客户端序号+1），seq=x(x随机产生)报文发送给客户端以确认连接请求，进入syn_recv状态。
      - 第三次：客户端收到服务端的报文，检查ack是否等于x+1,ACK是否为1，回应一个ack=x+1报文，服务端检查到sck=x+1之后表示正确建立连接，三次握手结束，之后就可以开始传输数据了。
    - ![img](http://9017499461.linshutu.top/%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B.png)
    - 4次挥手（方便记忆：FIN>ACK>FIN>ACK）
      - 第一次：客户端向服务器发送报文，同时携带序号seq=x和FIN.
      - 第二次：服务端回复ack报文和FIN后，附带确认序号ack=x+1表示服务器已经接收到了客户端的报文，但是由于服务器还在处理事物，因此报文会携带fin标识。
      - 第三次：在一段时间后，服务器已经处理完毕，发送带有fin=1和ack=x+1的报文，用来关闭服务端和客户端的数据传送.
      - 第四次：客服端收到FIN后，接着发送ack=x+1报文给服务端，完成四次挥手。
    - ![img](http://9017499461.linshutu.top/%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B.png)
  
- ```
  3次握手和4次挥手的流程是什么？
  答：就是当面的
  为什么连接是三次握手，而关闭时四次挥手？
  答：因为服务端在listen的状态下，收到建立连接请求的SYN报文后，把ACK和SYN放在一个报文发送给客户端。而关闭连接时，当收到对方的FIN报文时，仅仅表示对方不再发送数据了，但是还能接收数据，己方也未必全部数据都发送给对方了，所以己方可以立即close，也可以发送一些数据给 对方后，再发送FIN报文给对方来标识同意现在关闭连接，因此，己方ACK和FIN一般都会分开发送。
  ```
  
- UDP协议：
  
  - 不可靠传输，报头部分一共只有8个字节，总长度超过65535字节，正好放进一个数据包。
  - 报头
    - 以太网头+IP头+udp头+数据
    - ![](http://9017499461.linshutu.top/5.JPG)

### 总结

==========================================

物理层

作用：定义一些电器，机械，过程和规范，如集线器；

PDU(协议数据单元)：bit/比特

设备：集线器HUB;

注意：没有寻址的概念；

==========================================

数据链路层

作用：定义如何格式化数据，支持错误检测；

典型协议：以太网，帧中继（古董级VPN）

PDU：frame（帧）设备：以太网交换机；

备注：交换机通过MAC地址转发数据，逻辑链路控制；

===========================================

网络层

作用：定义一个逻辑的寻址，选择最佳路径传输，路由数据包；

典型协议：IP，IPX，ICMP,ARP(IP->MAC),IARP;

PDU:packet/数据包；

设备：路由器

备注：实现寻址

============================================

传输层：

作用：提供可靠和尽力而为的传输；

典型协议：TCP,UDP,SPX,port(65535个端口),EIGRP,OSPF,

PDU:fragment 段；

无典型设备；

备注：负责网络传输和会话建立；

=============================================

会话层：

作用：控制会话，建立管理终止应用程序会话；

典型协议：NFS, SQL, ASP, PHP, JSP, RSVP(资源源预留协议), windows， 

备注：负责会话建立；

==============================================

表示层：

作用：格式化数据；

典型协议：ASCII, JPEG. PNG, MP3. WAV, AVI, 

备注：可以提供加密服务；

===============================================

应用层：

作用：控制应用程序；

典型协议：telnet, ssh, http, ftp, smtp, rip, BGP, (未完待续)

备注：为应用程序提供网络服务；

![](http://9017499461.linshutu.top/3.png)

